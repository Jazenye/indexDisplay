<!DOCTYPE html>
<html lang="en">

<head>
    <meta charset="UTF-8" />
    <title>木桶布局</title>
    <style type="text/css">
        * {
            margin: 0;
            padding: 0;
        }

        #img-preview {
            width: 1000px;
            margin: 0 auto;
        }

        .img-row:after {
            content: "";
            display: block;
            clear: both;
        }

        .img-box {
            float: left;
        }

        .img-line .img-box:first-child {
            padding-left: 0;
        }
    </style>
    <script type="text/javascript" src="../jquery-3.1.1.js"></script>
    <script>
        window.onload = function () {

            function Barrels(wrap) {
                this.wrap = wrap;
                this.baseHeight = 100;
                this.loadImg();
                this.rowImg = [];
                this.wrapWidth = parseInt(getStyle(wrap, 'width'));
            }

            Barrels.prototype = {
                //加载图片
                loadImg: function () {

                    //得到链接数组
                    var aUrls = this.getImgUrls(100);

                    for (var i = 0; i < aUrls.length; i++) {
                        var _this = this;

                        //想要得到图片的宽高，就要用new预加载
                        var oImg = new Image();

                        //图片对象加url
                        oImg.src = aUrls[i];

                        //图片加载完成后才能对它的宽和高进行操作
                        oImg.onload = function () {
                            var ratio = this.width / this.height
                            var imgInfo = {
                                target: this,
                                //new对象有width和height属性
                                width: this.width / this.height * _this.baseHeight,
                                height: _this.baseHeight,
                                ratio: ratio
                            };

                            //计算每一行容纳的imgInfo的个数
                            _this.render(imgInfo);
                        };

                    }
                },
                render: function (imgInfo) {
                    console.log(imgInfo);
                    var rowWidth = 0;
                    var rowHeight = 0;
                    this.rowImg.push(imgInfo);
                    for (var i = 0; i < this.rowImg.length; i++) {
                        rowWidth = rowWidth + this.rowImg[i].width;
                    }
                    if (rowWidth > this.wrapWidth) {
                        console.log(rowWidth);
                        var lastImg = this.rowImg.pop();
                        rowWidth = rowWidth - lastImg.width;
                        console.log(rowWidth);
                        rowHeight = this.wrapWidth * this.baseHeight / rowWidth;

                        this.layout(rowHeight);
                        this.rowImg = [];
                        this.rowImg.push(lastImg);

                    }
                },
                layout: function (rowNewHeight) {
                    console.log(rowNewHeight);
                    var imgRow = document.createElement('div');
                    imgRow.className = 'img-row';
                    console.log(this.rowImg);
                    this.rowImg.forEach(function (imgInfo, idx) {
                        var imgCt = document.createElement('div');
                        imgCt.className = 'img-box';
                        var oImg = imgInfo.target;
                        oImg.style.height = rowNewHeight + 'px';
                        imgCt.appendChild(oImg);
                        imgRow.appendChild(imgCt);
                    });
                    this.wrap.appendChild(imgRow);
                },
                //获取图片的url
                getImgUrls: function getImgUrls(num) {
                    var imgColor, imgWidth, imgHeight, urls = [];
                    for (var i = 0; i < num; i++) {
                        //颜色色值转化为16进制
                        imgColor = Math.random().toString().substring(2, 8);

                        //设置随机的宽度
                        imgWidth = Math.floor(Math.random() * 150 + 50);

                        //设置随机的高度
                        imgHeight = Math.floor(Math.random() * 30 + 50);

                        //将颜色宽高放入数组
                        urls.push('http://placehold.it/' + imgWidth + 'x' + imgHeight + '/' + imgColor +
                            '/fff')

                    }
                    return urls;
                }
            }

            var oWrap = document.getElementById('img-preview');
            var barrels = new Barrels(oWrap);



            //封装一个获取样式的函数
            function getStyle(obj, attr) {
                if (obj.currentStyle) {
                    return obj.currentStyle[attr];
                } else {
                    //非ie
                    return window.getComputedStyle(obj, false)[attr];
                }
            }






        }
    </script>
</head>

<body>
    <div id="img-preview"></div>
</body>

</html>